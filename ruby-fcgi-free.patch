diff -ur o-ruby-fcgi-0.8.5/ext/fcgi/fcgi.c ruby-fcgi-0.8.5/ext/fcgi/fcgi.c
--- o-ruby-fcgi-0.8.5/ext/fcgi/fcgi.c	2005-03-22 14:28:36.000000000 -0700
+++ ruby-fcgi-0.8.5/ext/fcgi/fcgi.c	2005-03-23 09:59:03.726460213 -0700
@@ -41,6 +41,12 @@
   rb_gc_mark(data->env);
 }
 
+static void fcgi_free_req(fcgi_data *data)
+{
+  free(data->req);
+  free(data);
+}
+
 static VALUE fcgi_s_accept(VALUE self)
 {
   int status;
@@ -68,7 +74,7 @@
     VALUE obj,key, value;
     char *pkey,*pvalue;
     
-    obj = Data_Make_Struct(self, fcgi_data, fcgi_mark, 0, data);
+    obj = Data_Make_Struct(self, fcgi_data, fcgi_mark, fcgi_free_req, data);
     data->req = req;
     data->in  = Data_Wrap_Struct(cFCGIStream, 0, 0, req->in);
     data->out = Data_Wrap_Struct(cFCGIStream, 0, 0, req->out);
@@ -385,7 +391,10 @@
     buff = ALLOC_N(char, 16384);
     n = FCGX_GetStr(buff, 16384, stream);
     CHECK_STREAM_ERROR(stream);
-    if (n == 0) return Qnil;
+    if (n == 0) {
+      free(buff);
+      return  Qnil;
+    }
     str = rb_str_new(buff, n);
     OBJ_TAINT(str);
     
@@ -395,9 +404,11 @@
       if (n > 0) {
         rb_str_cat(str, buff, n);
       } else {
+        free(buff);
         return Qnil;
       }
     }
+    free(buff);
     return str;
   }
 
@@ -410,9 +421,11 @@
   if (n > 0) {
     str = rb_str_new(buff, n);
     OBJ_TAINT(str);
+    free(buff);
     return str;
   }
   else {
+    free(buff);
     return Qnil;
   }
 }
Only in ruby-fcgi-0.8.5/ext/fcgi: fcgi.c.orig
